<!DOCTYPE html>
<html>

<head>
  <title>miniflash</title>
  <script type="text/javascript">
    /// quine magic ///

    function promptDownload(filename, contents) {
      let blob = new Blob([contents], { "type": "text/plain" });
      let blobUrl = URL.createObjectURL(blob);

      let a = document.createElement("a");
      a.href = blobUrl;
      a.download = filename;
      a.click();

      URL.revokeObjectURL(blobUrl);
      a.remove();
    }

    function quine() {
      let clone = document.documentElement.cloneNode(true);

      //remove dynamism from the page
      clone.querySelectorAll(".noquine, .noquineinside *").forEach(elem => elem.remove());

      //save script variables
      let globalsToSave = ["cards", "generation"];
      generation++; //bump the generation up
      let globalsScript = "\n";
      for (global of globalsToSave) {
        let realizedGlobal = globalThis[global];
        let cryoGlobal = realizedGlobal.cryo ? realizedGlobal.cryo() : JSON.stringify(realizedGlobal);
        globalsScript += "globalThis." + global + " = " + cryoGlobal + ";\n";
      }
      clone.querySelector("#globals").innerHTML = globalsScript;
      generation--; //keep *my* generation the same

      //create page
      let outer = "<!DOCTYPE html>\n" + clone.outerHTML;
      console.log(outer);
      promptDownload("index.html", outer);
    }

    function escapeQuote(s) {
      return s.replace("\"", "\\\"");
    }

    /// DOM utilties ///

    function setContents(id, elems) {
      let container = document.getElementById(id);
      while (container.firstChild) container.firstChild.remove();
      if (!Array.isArray(elems)) elems = [elems];
      for (let e of elems) container.appendChild(e);
    }

    /// cards ///

    class Card {
      //string
      id;
      
      //string
      front;
      
      //string
      back;

      constructor(props) {
        this.id = props.id;
        this.front = props.front;
        this.back = props.back;
      }

      cryo() {
        return `new Card({id:${JSON.stringify(this.id)},front:${JSON.stringify(this.front)},back:${JSON.stringify(this.back)}})`;
      }
      
      renderCard(side) {
        let div = document.createElement("div");
        div.classList = ["card", side ? "front" : "back"];
        div.innerHtml = side ? this.front : this.back;
        return div;
      }
    }

    class Deck {
      //string
      id;

      //card[]
      cards;

      //map<string, card>
      cardsById;

      constructor(props) {
        this.id = props.id;
        this.cards = props.cards;

        this.cardsById = {};
        for (let card of this.cards) {
          this.cardsById[card.id] = card;
        }
      }

      cryo() {
        return `new Deck({id:"${escapeQuote(this.id)}",cards:[${this.cards.map(card => card.cryo()).join(",")}]})`;
      }
    }

    class CardDatabase {
      //deck[]
      decks;

      //map<string, deck>
      decksById;

      constructor(props) {
        this.decks = props.decks;

        this.decksById = {};
        for (let deck of this.decks) {
          this.decksById[deck.id] = deck;
        }
      }

      cryo() {
        return `new CardDatabase({decks:[${this.decks.map(deck => deck.cryo()).join(",")}]})`;
      }

      renderPicker() {
        let ul = document.createElement("ul");

        for (let deck of this.decks) {
          let li = document.createElement("li");
          li.addEventListener("click", e => pickDeck(deck));
          li.innerText = deck.id;
          ul.appendChild(li);
        }

        return ul;
      }
    }

    class Study {
      //deck
      deck;

      //string[] (card ids)
      toStudy;

      //string[] (card ids)
      correct;

      //string[] (card ids)
      incorrect;
      
      //card id
      currentCardId;
      
      //various html elements
      studyElement;

      constructor(props) {
        this.deck = props.deck;

        this.toStudy = Object.keys(deck.cardsById);
        for (let i = toStudy.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [toStudy[i], toStudy[j]] = [toStudy[j], toStudy[i]];
        }
        this.correct = [];
        this.incorrect = [];
        
        this.currentCardId = this.toStudy.pop();
      }
      
      renderStudy() {
        this.studyElement = document.createElement("div");
        this.studyElement.class = "study";
        
        let cardElement = this.deck.cardsById[this.currentCardId].renderCard();
        this.studyElement.appendChild();
      }
    }

    /// State ///

    let currentDeck = undefined;
    let currentCard = undefined;

    document.addEventListener("DOMContentLoaded", e => {
      let picker = globalThis.cards.renderPicker();

      setContents("container", picker);
      console.log(picker);
      console.log(globalThis.cards);
      console.log(globalThis.cards.cryo());
      console.log(eval(globalThis.cards.cryo()))
    });
  </script>
  <script type="text/javascript" id="globals">
    globalThis.generation = 0;

    globalThis.cards = new CardDatabase({
      decks: [
        new Deck({
          id: "foo",
          cards: [
            new Card({ id: "foo" }),
            new Card({ id: "bar" }),
          ]
        }),
        new Deck({
          id: "foo2",
          cards: [
            new Card({ id: "foo2" }),
            new Card({ id: "bar2" }),
          ]
        }),
      ]
    });
  </script>
</head>

<body>
  <h1>miniflash</h1>
  <div id="container" class="noquineinside"></div>
  <button onclick="quine()">clone</button>
</body>

</html>