<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>flashed cards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>
    "use strict";

    class Flashcard {
      id; front; back;

      constructor(props) {
        Object.assign(this, props);
      }

      cryo() {
        return `new Flashcard(${JSON.stringify(this)})`;
      }
    }

    class CardDeck {
      id; cards;

      cardsById;

      constructor(props) {
        Object.assign(this, props);

        this.cardsById = {};
        for (let card of this.cards) {
          this.cardsById[card.id] = card;
        }
      }

      cryo() {
        return `new CardDeck({id:"${this.id}",cards:[${this.cards.map(card => card.cryo()).join(",")}]})`;
      }
    }

    class Database {
      decks; decksById;

      constructor(props) {
        Object.assign(this, props);
        console.log(this);

        this.decksById = {};
        for (let deck of this.decks) {
          this.decksById[deck.id] = deck;
        }
      }

      cryo() {
        return `new Database({decks:[${this.decks.map(deck => deck.cryo()).join(",")}]})`;
      }
    }

  </script>
  <script id="globals">
    "use strict";
    globalThis.generation = 0;
    globalThis.database = new Database({ decks: [new CardDeck({ id: "deck", cards: [new Flashcard({ id: "foo", front: "FRONT", back: "BACK" })] })] });
  </script>
  <script>
    "use strict";

    function $(sel) {
      let result = document.querySelectorAll(sel);
      if (sel[0] == '#' && result.length == 1) return result[0]; //act more like getElementById
      else return result; //else return all the elements
    }

    let toStudy = [];
    
    let currentDeck = undefined;
    let currentCard = undefined;
    let currentSide = "front";

    //show contents of a card in the html element
    function display() {
      let card = globalThis.database.decksById[currentDeck].cardsById[currentCard];
      
      $("#card").innerHTML = card[currentSide];
      $("#card").style.backgroundColor = (currentSide == "front" ? "white" : "#DEDEDE"); //todo use classes
    }

    //flop current card to the other side
    function flip() {
      currentSide = (currentSide == "front" ? "back" : "front");
      display();
    }

    //repopulate and shuffle the pile of cards to study
    function reshuffle() {
      let deck = globalThis.database.decksById[currentDeck];
      
      toStudy = Object.keys(deck.cardsById);
      for (let i = toStudy.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [toStudy[i], toStudy[j]] = [toStudy[j], toStudy[i]];
      }
      console.log("shuffled! ", toStudy);
    }

    //draw a card from the deck
    function another() {
      if (toStudy.length == 0) reshuffle();

      currentCard = toStudy[toStudy.length - 1];
      display();
      toStudy.pop();
    }

    function quine() {
      let copy = document.documentElement.cloneNode(true);
      copy.querySelectorAll(".dynamic, .dynamic-inside *").forEach(elem => elem.remove());
      copy.querySelectorAll(".dynamic-inside").forEach(elem => {
        while (elem.firstChild) elem.firstChild.remove();
      });

      generation++;

      let globalsToSave = ["generation", "database"];
      let globalsScript = `\n"use strict";\n`;
      for (let globalName of globalsToSave) {
        let global = globalThis[globalName];
        console.log(globalName, global);
        let cryo = global.cryo ? global.cryo() : JSON.stringify(global);
        
        globalsScript += globalName + " = " + cryo + ";\n";
      }

      generation--; //restore
      copy.querySelector("#globals").innerHTML = globalsScript;

      let stringified = `<!DOCTYPE html>\n` + copy.outerHTML;

      //download
      if(true) {
        console.log(stringified);
        return;
      }
      
      let blob = new Blob([stringified], { type: "text/html" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = "quine.html";
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    }

    document.addEventListener("DOMContentLoaded", () => {
      $("#generation").innerHTML = globalThis.generation;
      
      //initialize the current deck and such
      currentDeck = globalThis.database.decks[0].id;
      
      
      $("#card").addEventListener("click", () => flip());
      $("#another").addEventListener("click", (e) => {
        another();
        e.target.blur(); //so pressing space doesnt press the button again
      });
      $("#save").addEventListener("click", () => quine());

      //disable double-click-to-select on the card
      $("#card").addEventListener("mousedown", e => {
        if (e.detail > 1) e.preventDefault();
      });

      //hotkeys
      document.addEventListener("keypress", e => {
        if (e.key == "a") another();
        else if (e.key == " ") flip();
      });

      //initial shuffle
      another();
    });

  </script>
  <style>
    html,
    body {
      margin: 0;
    }

    body {
      padding-top: 3em;
      gap: 3em;
      background-color: lightgray;

      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #card {
      width: 35rem;
      height: 20rem;
      background-color: white;
      color: black;
      font-size: 3rem;
      border: 3px solid black;
      box-shadow: 3px 3px 0px gray;

      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    #another {
      font-size: 3rem;
    }

    @media(max-width: 600px) {
      #card {
        width: 90vw;
        font-size: 2rem;
      }

      #another u {
        text-decoration: none;
      }
    }
  </style>
</head>

<body>
  <h1>miniflash</h1>
  <div id="card" class="dynamic-inside"></div>
  <button id="another"><u>a</u>nother</button>
  <button id="save">save (generation <span id="generation"></span>)</button>
</body>

</html>